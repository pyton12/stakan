<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Agency TMA</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            color: #333;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            font-size: 18px;
            margin-bottom: 16px;
            color: #667eea;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 500;
            color: #666;
        }

        .info-value {
            font-weight: 600;
            color: #333;
            word-break: break-all;
            max-width: 60%;
            text-align: right;
        }

        .premium-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 32px 24px;
        }

        .premium-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .premium-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .premium-description {
            opacity: 0.9;
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .premium-price {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 24px;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: white;
            color: #667eea;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .event-log {
            max-height: 300px;
            overflow-y: auto;
        }

        .event-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .event-item.success {
            background: #d4edda;
            color: #155724;
        }

        .event-item.error {
            background: #f8d7da;
            color: #721c24;
        }

        .event-item.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .event-time {
            font-size: 11px;
            opacity: 0.7;
            margin-bottom: 4px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            background: #667eea;
            color: white;
        }

        .badge.success {
            background: #28a745;
        }

        .badge.warning {
            background: #ffc107;
            color: #333;
        }

        .storage-info {
            background: #e7f3ff;
            border: 2px solid #2196F3;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }

        .storage-info h3 {
            color: #1976D2;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .storage-count {
            font-size: 24px;
            font-weight: bold;
            color: #1976D2;
            text-align: center;
            margin: 8px 0;
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #667eea;
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ Test Agency TMA</h1>
            <p>–¢–µ—Å—Ç–æ–≤–∏–π Mini App –¥–ª—è SDK</p>
        </div>

        <!-- User Info Card -->
        <div class="card">
            <h2>üë§ –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</h2>
            <div class="info-row">
                <span class="info-label">User ID:</span>
                <span class="info-value" id="userId">Loading...</span>
            </div>
            <div class="info-row">
                <span class="info-label">Username:</span>
                <span class="info-value" id="username">Loading...</span>
            </div>
            <div class="info-row">
                <span class="info-label">Language:</span>
                <span class="info-value" id="language">Loading...</span>
            </div>
            <div class="info-row">
                <span class="info-label">Platform:</span>
                <span class="info-value" id="platform">Loading...</span>
            </div>
        </div>

        <!-- Campaign Info Card -->
        <div class="card">
            <h2>üìä Campaign Tracking</h2>
            <div class="info-row">
                <span class="info-label">Campaign ID:</span>
                <span class="info-value" id="campaignId">Not found</span>
            </div>
            <div class="info-row">
                <span class="info-label">Source:</span>
                <span class="info-value" id="source">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">Start Param:</span>
                <span class="info-value" id="startParam" style="font-size: 11px;">-</span>
            </div>
            
            <!-- –õ–æ–∫–∞–ª—å–Ω–µ —Å—Ö–æ–≤–∏—â–µ -->
            <div class="storage-info">
                <h3>üíæ –õ–æ–∫–∞–ª—å–Ω–µ —Å—Ö–æ–≤–∏—â–µ (localStorage)</h3>
                <div class="storage-count" id="storageCount">0</div>
                <div style="text-align: center; font-size: 12px; color: #666;">
                    –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö –ø–æ–¥—ñ–π
                </div>
                <button class="btn-secondary" onclick="viewStorage()">
                    –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –≤—Å—ñ –ø–æ–¥—ñ—ó
                </button>
                <button class="btn-secondary" onclick="clearStorage()" style="background: #ffebee; color: #c62828;">
                    –û—á–∏—Å—Ç–∏—Ç–∏ —Å—Ö–æ–≤–∏—â–µ
                </button>
            </div>
        </div>

        <!-- Premium Card -->
        <div class="card premium-card">
            <div class="premium-icon">üíé</div>
            <div class="premium-title">Premium Access</div>
            <div class="premium-description">
                –û—Ç—Ä–∏–º–∞–π—Ç–µ –¥–æ—Å—Ç—É–ø –¥–æ –≤—Å—ñ—Ö —Ñ—É–Ω–∫—Ü—ñ–π —Ç–∞ –≤–∏–¥–∞–ª—ñ—Ç—å —Ä–µ–∫–ª–∞–º—É
            </div>
            <div class="premium-price">‚≠ê 10 Stars</div>
            <button class="btn btn-primary" id="buyButton" onclick="buyPremium()">
                –ö—É–ø–∏—Ç–∏ Premium
            </button>
            <div style="margin-top: 12px; font-size: 12px; opacity: 0.8;">
                ‚ÑπÔ∏è –î–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è: –ø–ª–∞—Ç—ñ–∂ –±—É–¥–µ —Å–∏–º—É–ª—å–æ–≤–∞–Ω–æ
            </div>
        </div>

        <!-- Event Log Card -->
        <div class="card">
            <h2>üìù –õ–æ–≥ –ø–æ–¥—ñ–π</h2>
            <div class="event-log" id="eventLog">
                <div class="event-item info">
                    –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è TMA...
                </div>
            </div>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        let campaignId = null;
        let userId = null;
        let eventCounter = 0;

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è TMA
        function init() {
            tg.ready();
            tg.expand();

            // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Ç–µ–º—É
            document.body.style.backgroundColor = tg.backgroundColor || '#667eea';

            addLog('‚úì TMA —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ', 'success');

            // –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
            const user = tg.initDataUnsafe?.user;
            
            if (user) {
                userId = user.id;
                document.getElementById('userId').textContent = user.id;
                document.getElementById('username').textContent = user.username || 'No username';
                document.getElementById('language').textContent = user.language_code || 'en';
                addLog(`‚úì –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: ${user.first_name} (ID: ${user.id})`, 'success');
            } else {
                // –î–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –≤ –±—Ä–∞—É–∑–µ—Ä—ñ
                userId = 'browser_test_' + Date.now();
                document.getElementById('userId').textContent = 'Browser Test Mode';
                document.getElementById('username').textContent = '@testuser';
                document.getElementById('language').textContent = 'en';
                addLog('‚ÑπÔ∏è –†–µ–∂–∏–º —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –≤ –±—Ä–∞—É–∑–µ—Ä—ñ', 'info');
            }

            document.getElementById('platform').textContent = tg.platform || 'web';

            // –í–∏—Ç—è–≥—É—î–º–æ campaign_id –∑ start_param
            extractCampaignId();

            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ–¥—ñ—é app_open
            saveEvent('app_open', {
                campaign_id: campaignId,
                user_id: userId,
                timestamp: Date.now()
            });

            // –û–Ω–æ–≤–ª—é—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫ —Å—Ö–æ–≤–∏—â–∞
            updateStorageCount();
        }

        // –í–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è campaign_id
        function extractCampaignId() {
            const startParam = tg.initDataUnsafe?.start_param;
            
            if (!startParam) {
                // –°–ø—Ä–æ–±—É—î–º–æ –∑ URL (–¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –≤ –±—Ä–∞—É–∑–µ—Ä—ñ)
                const urlParams = new URLSearchParams(window.location.search);
                const utmCampaign = urlParams.get('utm_campaign');
                
                if (utmCampaign) {
                    campaignId = utmCampaign;
                    document.getElementById('campaignId').innerHTML = 
                        `<span class="badge success">${campaignId}</span>`;
                    document.getElementById('source').textContent = 'UTM –ø–∞—Ä–∞–º–µ—Ç—Ä–∏';
                    document.getElementById('startParam').textContent = 'utm_campaign=' + utmCampaign;
                    addLog('‚úì Campaign ID –≤–∏—Ç—è–≥–Ω—É—Ç–æ –∑ UTM', 'success');
                    return;
                }
                
                addLog('‚ö†Ô∏è Start param –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –í—ñ–¥–∫—Ä–∏–π—Ç–µ TMA —á–µ—Ä–µ–∑ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –∑ campaign_id', 'error');
                document.getElementById('campaignId').innerHTML = 
                    `<span class="badge warning">–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ</span>`;
                return;
            }

            document.getElementById('startParam').textContent = startParam;

            // –°–ø—Ä–æ–±–∞ –¥–µ–∫–æ–¥—É–≤–∞—Ç–∏ base64
            try {
                const decoded = JSON.parse(atob(startParam));
                campaignId = decoded.cid || decoded.campaign_id || decoded.c;
                
                if (campaignId) {
                    document.getElementById('campaignId').innerHTML = 
                        `<span class="badge success">${campaignId}</span>`;
                    document.getElementById('source').textContent = decoded.src || decoded.source || 'Base64';
                    addLog('‚úì Campaign ID –≤–∏—Ç—è–≥–Ω—É—Ç–æ –∑ Base64', 'success');
                    addLog(`  ‚Üí CID: ${campaignId}`, 'info');
                } else {
                    addLog('‚ö†Ô∏è Campaign ID –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ Base64', 'error');
                }
            } catch (e) {
                // –Ø–∫—â–æ –Ω–µ base64, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —è–∫ —î
                campaignId = startParam;
                document.getElementById('campaignId').innerHTML = 
                    `<span class="badge success">${campaignId}</span>`;
                document.getElementById('source').textContent = 'Direct (raw)';
                addLog('‚úì Campaign ID –≤–∏—Ç—è–≥–Ω—É—Ç–æ (raw format)', 'success');
            }
        }

        // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø–æ–¥—ñ—ó –≤ localStorage
        function saveEvent(eventType, data) {
            const events = JSON.parse(localStorage.getItem('tma_events') || '[]');
            
            const event = {
                id: ++eventCounter,
                event_type: eventType,
                ...data,
                created_at: new Date().toISOString()
            };
            
            events.push(event);
            localStorage.setItem('tma_events', JSON.stringify(events));
            
            addLog(`üíæ –ü–æ–¥—ñ—è "${eventType}" –∑–±–µ—Ä–µ–∂–µ–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ (#${event.id})`, 'success');
            updateStorageCount();
            
            return event;
        }

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ —Å—Ö–æ–≤–∏—â–∞
        function updateStorageCount() {
            const events = JSON.parse(localStorage.getItem('tma_events') || '[]');
            document.getElementById('storageCount').textContent = events.length;
        }

        // –ü–µ—Ä–µ–≥–ª—è–¥ –≤—Å—å–æ–≥–æ —Å—Ö–æ–≤–∏—â–∞
        function viewStorage() {
            const events = JSON.parse(localStorage.getItem('tma_events') || '[]');
            
            if (events.length === 0) {
                tg.showAlert('–°—Ö–æ–≤–∏—â–µ –ø–æ—Ä–æ–∂–Ω—î. –ó—Ä–æ–±—ñ—Ç—å —è–∫—É—Å—å –¥—ñ—é (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –∫—É–ø—ñ—Ç—å Premium)');
                return;
            }

            let message = `üìä –í—Å—å–æ–≥–æ –ø–æ–¥—ñ–π: ${events.length}\n\n`;
            
            // –ü–æ–∫–∞–∑—É—î–º–æ –æ—Å—Ç–∞–Ω–Ω—ñ 5 –ø–æ–¥—ñ–π
            const recent = events.slice(-5).reverse();
            recent.forEach((e, i) => {
                const time = new Date(e.created_at).toLocaleTimeString();
                message += `${i + 1}. ${e.event_type}\n`;
                message += `   –ß–∞—Å: ${time}\n`;
                if (e.campaign_id) message += `   Campaign: ${e.campaign_id}\n`;
                if (e.amount) message += `   –°—É–º–∞: ${e.amount} ${e.currency}\n`;
                message += '\n';
            });

            if (events.length > 5) {
                message += `... —Ç–∞ —â–µ ${events.length - 5} –ø–æ–¥—ñ–π`;
            }

            tg.showAlert(message);
            
            // –¢–∞–∫–æ–∂ –≤–∏–≤–æ–¥–∏–º–æ –≤ console
            console.log('üìä –í—Å—ñ –ø–æ–¥—ñ—ó:', events);
        }

        // –û—á–∏—â–µ–Ω–Ω—è —Å—Ö–æ–≤–∏—â–∞
        function clearStorage() {
            if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –ø–æ–¥—ñ—ó?')) {
                localStorage.removeItem('tma_events');
                eventCounter = 0;
                updateStorageCount();
                addLog('üóëÔ∏è –°—Ö–æ–≤–∏—â–µ –æ—á–∏—â–µ–Ω–æ', 'info');
            }
        }

        // –ü–æ–∫—É–ø–∫–∞ Premium
        function buyPremium() {
            const button = document.getElementById('buyButton');
            button.disabled = true;
            button.textContent = '–û–±—Ä–æ–±–∫–∞...';

            addLog('üí≥ –Ü–Ω—ñ—Ü—ñ–∞—Ü—ñ—è –ø–ª–∞—Ç–µ–∂—É –∑–∞ Premium...', 'info');

            // –ü–†–ò–ú–Ü–¢–ö–ê: –í —Ä–µ–∞–ª—å–Ω–æ–º—É –∑–∞—Å—Ç–æ—Å—É–Ω–∫—É —Ç—É—Ç –±—É–¥–µ tg.openInvoice()
            // –î–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è —Å–∏–º—É–ª—é—î–º–æ –ø–ª–∞—Ç—ñ–∂
            
            setTimeout(() => {
                // –°–∏–º—É–ª—é—î–º–æ —É—Å–ø—ñ—à–Ω–∏–π –ø–ª–∞—Ç—ñ–∂
                const transactionId = 'test_txn_' + Date.now();
                
                const paymentEvent = saveEvent('payment', {
                    campaign_id: campaignId,
                    user_id: userId,
                    amount: 10,
                    currency: 'stars',
                    transaction_id: transactionId,
                    product_id: 'premium_access'
                });

                addLog(`‚úì –ü–ª–∞—Ç—ñ–∂ —É—Å–ø—ñ—à–Ω–∏–π! Transaction ID: ${transactionId}`, 'success');
                addLog(`üíé Premium –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ! –ü–æ–¥—ñ—è #${paymentEvent.id} –∑–±–µ—Ä–µ–∂–µ–Ω–∞`, 'success');
                
                button.textContent = '‚úì Premium –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ';
                button.style.background = '#28a745';
                button.style.color = 'white';
                
                // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
                tg.showAlert('üéâ Premium —É—Å–ø—ñ—à–Ω–æ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ!\n\n–ü–æ–¥—ñ—è –∑–±–µ—Ä–µ–∂–µ–Ω–∞ –≤ localStorage.');
                
            }, 1500);
        }

        // –î–æ–¥–∞–≤–∞–Ω–Ω—è –ª–æ–≥—É
        function addLog(message, type = '') {
            const logContainer = document.getElementById('eventLog');
            
            const eventItem = document.createElement('div');
            eventItem.className = `event-item ${type}`;
            
            const time = new Date().toLocaleTimeString();
            eventItem.innerHTML = `
                <div class="event-time">${time}</div>
                <div>${message}</div>
            `;
            
            logContainer.insertBefore(eventItem, logContainer.firstChild);

            // –û–±–º–µ–∂—É—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ª–æ–≥—ñ–≤
            const items = logContainer.querySelectorAll('.event-item');
            if (items.length > 15) {
                items[items.length - 1].remove();
            }
        }

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        // –ï–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–∏—Ö –≤ console –ø—Ä–∏ –ø–æ–¥–≤—ñ–π–Ω–æ–º—É –∫–ª—ñ–∫—É
        document.querySelector('.event-log').addEventListener('dblclick', () => {
            const events = JSON.parse(localStorage.getItem('tma_events') || '[]');
            console.log('üìä –ï–∫—Å–ø–æ—Ä—Ç –≤—Å—ñ—Ö –ø–æ–¥—ñ–π:', events);
            console.log('üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:', {
                total: events.length,
                app_opens: events.filter(e => e.event_type === 'app_open').length,
                payments: events.filter(e => e.event_type === 'payment').length,
                campaigns: [...new Set(events.map(e => e.campaign_id).filter(Boolean))]
            });
            addLog('üì§ –î–∞–Ω—ñ –µ–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ –≤ console (F12)', 'info');
        });
    </script>
</body>
</html>